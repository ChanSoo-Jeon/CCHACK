<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>쓰레기 해결 • Kakao Map (춘천)</title>
  <!-- Kakao Map JS SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ClientID"></script>

  <style>
    :root { --line:#e5e7eb; --bg:#f6f7f9; --card:#fff; --danger:#ff1f43; }
    html,body{height:100%;margin:0;font-family:"Noto Sans KR",system-ui,sans-serif;background:var(--bg)}
    header{height:56px;display:flex;align-items:center;justify-content:center;
           background:#fff;border-bottom:1px solid var(--line);font-weight:700}

    .container{height:calc(100% - 56px);display:flex;flex-direction:column}
    .map-wrap{flex:1;position:relative}
    #map{position:absolute;inset:0}

    /* FAB */
    .fab{position:fixed;right:16px;top:70px;z-index:9999;
         width:56px;height:56px;border-radius:50%;background:var(--danger);
         display:flex;align-items:center;justify-content:center;
         color:#fff;border:0;cursor:pointer;
         box-shadow:0 8px 18px rgba(0,0,0,.25)}
    .fab svg{width:28px;height:28px}

    /* 목록 공통 */
    .list{background:#fff;border-top:1px solid var(--line);overflow:auto}
    .item{padding:12px;border-bottom:1px solid var(--line)}
    .title{font-weight:600}
    .addr{font-size:12px;color:#666}
    .pagination{display:flex;justify-content:center;gap:6px;padding:8px}
    .pagination button{border:1px solid var(--line);background:#fff;
                       padding:4px 8px;border-radius:4px;cursor:pointer}
    .pagination button.active{background:#333;color:#fff}

    /* 모바일: 바텀시트(스와이프) + 모든 항목 스크롤 */
    @media (max-width: 767px){
      .list{
        position:fixed;left:0;right:0;bottom:0;z-index:9998;
        max-height:80vh;height:50vh;border-radius:16px 16px 0 0;
        box-shadow:0 -12px 20px rgba(0,0,0,.12);
        transform:translateY(70%);transition:transform .25s ease;
        touch-action:none;will-change:transform;user-select:none;
      }
      .list.open{transform:translateY(0)}
      .handle{width:44px;height:5px;border-radius:999px;background:#d1d5db;margin:10px auto 6px;cursor:grab}
      .pagination{display:none} /* 앱에선 페이지네이션 안 보임 (전체 스크롤) */
    }

    /* 웹: 지도 아래 고정(높이에 따라 더 많이/적게) */
    @media (min-width: 768px){
      .list{
        position:static;transform:none!important;
        height:clamp(200px, 32vh, 520px); /* 세로 길이에 비례해서 늘어남 */
        max-height:none;
      }
      .handle{display:none}
    }
  </style>
</head>
<body>
  <header>쓰레기 해결</header>

  <div class="container">
    <div class="map-wrap"><div id="map"></div></div>

    <!-- 목록 -->
    <div class="list" id="listPanel" aria-label="신고/해결 목록">
      <div class="handle" aria-hidden="true"></div>
      <div id="listContent"></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <!-- 우상단 사이렌 버튼 -->
  <button class="fab" id="fab" aria-label="신고/해결">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 11V9a5 5 0 0 1 10 0v2" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
      <rect x="4" y="11" width="16" height="7" rx="2" fill="rgba(255,255,255,.15)" stroke="#fff" stroke-width="1.6"/>
      <path d="M12 3v2M5.5 5.5l1.5 1.5M18.5 5.5 17 7" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <script>
    /************ 데이터(춘천 5곳) ************/
    const data = [
      {title:"쓰레기 신고",     addr:"춘천시 중앙로 67 (명동 일대)"},
      {title:"방치된 쓰레기",   addr:"춘천시 석사동 강원대학교 정문"},
      {title:"불법투기 의심",   addr:"춘천시 후평동 후평시장"},
      {title:"생활폐기물 신고", addr:"춘천시 퇴계동 홈플러스 근처"},
      {title:"방치된 폐가구",   addr:"춘천시 온의동 의암호 공원"}
    ];

    let currentPage = 1;
    let itemsPerPage = 2; // 웹에서 가용 높이에 따라 동적으로 변경됨
    const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

    function measureItemHeight() {
      // listContent에 샘플 아이템 하나 렌더해서 실제 높이 측정
      const listContent = document.getElementById('listContent');
      const probe = document.createElement('div');
      probe.className = 'item';
      probe.style.visibility = 'hidden';
      probe.innerHTML = `<div class="title">측정</div><div class="addr">가나다</div>`;
      listContent.appendChild(probe);
      const h = probe.offsetHeight || 64; // fallback
      listContent.removeChild(probe);
      return h;
    }

    function computeItemsPerPage() {
      if (isMobile()) return data.length; // 앱: 전부 보여줌
      const panel = document.getElementById('listPanel');
      const pagination = document.getElementById('pagination');
      // 가용 높이 = 패널 전체 높이 - 페이지네이션 높이 - 여유(약간의 패딩)
      const available = panel.clientHeight - (pagination.offsetHeight || 0) - 12;
      const itemH = measureItemHeight();
      const per = Math.max(1, Math.floor(available / itemH));
      return per;
    }

    function renderListWeb(page = 1) {
      itemsPerPage = computeItemsPerPage();
      const listContent = document.getElementById('listContent');
      const pagination  = document.getElementById('pagination');
      listContent.innerHTML = "";
      pagination.innerHTML  = "";

      const totalPages = Math.max(1, Math.ceil(data.length / itemsPerPage));
      // 현재 topIndex 유지되도록 페이지 보정
      const maxPage = totalPages;
      if (page > maxPage) page = maxPage;
      currentPage = page;

      const start = (currentPage - 1) * itemsPerPage;
      const items = data.slice(start, start + itemsPerPage);
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div class="title">${it.title}</div><div class="addr">${it.addr}</div>`;
        listContent.appendChild(div);
      });

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => renderListWeb(i);
        pagination.appendChild(btn);
      }
    }

    function renderListMobile() {
      const listContent = document.getElementById('listContent');
      const pagination  = document.getElementById('pagination');
      listContent.innerHTML = "";
      pagination.innerHTML  = ""; // 앱에선 페이지네이션 사용 안 함
      data.forEach(it => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div class="title">${it.title}</div><div class="addr">${it.addr}</div>`;
        listContent.appendChild(div);
      });
    }

    function renderListResponsive() {
      if (isMobile()) {
        renderListMobile();
      } else {
        renderListWeb(currentPage);
      }
    }

    /************ 바텀시트 스와이프(앱에서만) ************/
    let detachSwipe;
    function enableSwipeIfMobile() {
      const listPanel = document.getElementById('listPanel');
      const handle    = listPanel.querySelector('.handle');

      // 기존 바인딩 해제
      if (detachSwipe) { detachSwipe(); detachSwipe = null; }

      if (!isMobile()) {
        listPanel.style.transform = ''; // 웹에선 transform 해제/무시
        listPanel.classList.remove('open');
        return;
      }

      // 앱: 스와이프 활성화
      let basePercent = 70; // 닫힘
      setTranslate(basePercent);

      let dragging = false;
      let startY   = 0;

      function setTranslate(percent) {
        listPanel.style.transform = `translateY(${percent}%)`;
      }
      function getCurrentPercent() {
        const m = /translateY\(([-\d.]+)%\)/.exec(listPanel.style.transform);
        return m ? parseFloat(m[1]) : basePercent;
      }

      function onPointerDown(e){
        dragging = true;
        startY = e.clientY ?? (e.touches && e.touches[0].clientY) ?? 0;
        listPanel.style.transition = 'none';
        e.target.setPointerCapture?.(e.pointerId);
      }
      function onPointerMove(e){
        if(!dragging) return;
        const y = e.clientY ?? (e.touches && e.touches[0].clientY) ?? 0;
        const dy = y - startY;
        const deltaPercent = (dy / window.innerHeight) * 100;
        let next = basePercent + deltaPercent;
        next = Math.max(0, Math.min(70, next));
        setTranslate(next);
        e.preventDefault?.();
      }
      function onPointerUp(){
        if(!dragging) return;
        dragging = false;
        listPanel.style.transition = 'transform .25s ease';
        const current = getCurrentPercent();
        if (current > 40){ // 내려가면 닫힘
          basePercent = 70;
          listPanel.classList.remove('open');
        } else {          // 올리면 열림
          basePercent = 0;
          listPanel.classList.add('open');
        }
        setTranslate(basePercent);
      }

      const target = handle || listPanel;
      target.style.touchAction = 'none';
      target.addEventListener('pointerdown', onPointerDown, {passive:false});
      window.addEventListener('pointermove', onPointerMove, {passive:false});
      window.addEventListener('pointerup',   onPointerUp,   {passive:true});
      window.addEventListener('pointercancel', onPointerUp, {passive:true});

      detachSwipe = () => {
        target.removeEventListener('pointerdown', onPointerDown);
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup',   onPointerUp);
        window.removeEventListener('pointercancel', onPointerUp);
        listPanel.style.transition = '';
      };
    }

    /************ 초기화 ************/
    window.addEventListener('DOMContentLoaded', () => {
      // Kakao 지도 (춘천 중심)
      const mapEl   = document.getElementById('map');
      const options = { center: new kakao.maps.LatLng(37.8813, 127.7300), level: 5 };
      const map     = new kakao.maps.Map(mapEl, options);

      // 마커 5개(샘플)
      data.forEach(it=>{
        new kakao.maps.Marker({
          position: new kakao.maps.LatLng(
            37.8813 + (Math.random()-0.5)*0.02,
            127.7300 + (Math.random()-0.5)*0.02
          ),
          map, title: it.title
        });
      });

      renderListResponsive();   // 목록 최초 렌더
      enableSwipeIfMobile();    // 스와이프(앱에서만)

      // 리사이즈 시: 모드 변경/아이템 수 재계산/재바인딩
      window.addEventListener('resize', () => {
        const wasMobile = document.body.dataset.mobile === '1';
        const nowMobile = isMobile();
        document.body.dataset.mobile = nowMobile ? '1' : '0';

        if (nowMobile !== wasMobile) {
          // 모드 전환: 렌더 & 스와이프 바인딩 갱신
          renderListResponsive();
          enableSwipeIfMobile();
        } else if (!nowMobile) {
          // 웹 모드에서만 per-page 재계산
          renderListWeb(currentPage);
        }
      });
      // 초기 mobile flag 저장
      document.body.dataset.mobile = isMobile() ? '1' : '0';
    });
  </script>
</body>
</html>
