<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>쓰레기 해결 • Kakao Map (춘천)</title>

  <!-- Live Server일 때 -->
  <script src="/js/config.local.js"></script>
  <!-- Spring Boot로 구동 시 ↑를 /js/config.local.js 로 바꾸세요 -->

  <!-- Kakao SDK 동적 로더 (한 번만 초기화) -->
  <script>
    (function loadKakao() {
      if (!window.APP_KEY) { console.error("APP_KEY 없음. config.local.js 확인"); return; }
      var s = document.createElement("script");
      s.src = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=" + encodeURIComponent(window.APP_KEY) + "&autoload=false";
      s.async = true;
      s.onload = function(){ kakao.maps.load(initApp); };
      document.head.appendChild(s);

      function initApp(){
        var run = function(){
          // 지도
          var mapEl = document.getElementById("map");
          var map = new kakao.maps.Map(mapEl, { center:new kakao.maps.LatLng(37.8813,127.73), level:5 });
          bindMap(map);

          // 목록
          renderListResponsive();
          enableSwipeIfMobile();

          // 리사이즈
          var lastMobile = isMobile();
          window.addEventListener("resize", function(){
            var nowMobile = isMobile();
            if(nowMobile!==lastMobile){ lastMobile=nowMobile; renderListResponsive(); enableSwipeIfMobile(); }
            else if(!nowMobile){ renderListWeb(currentPage); }
          });
        };
        if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", run); else run();
      }
    })();
  </script>

  <style>
    :root { --line:#e5e7eb; --bg:#f6f7f9; --card:#fff; --danger:#ff1f43; --ink:#222; --muted:#6b7280; }
    html,body{height:100%;margin:0;font-family:"Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:var(--ink)}
    header{height:56px;display:flex;align-items:center;justify-content:center;background:#fff;border-bottom:1px solid var(--line);font-weight:700}

    .container{height:calc(100% - 56px);display:flex;flex-direction:column}
    .map-wrap{flex:1;position:relative}
    #map{position:absolute;inset:0}

    /* FAB (신고 전용) */
    .fab{position:fixed;right:16px;top:70px;z-index:9999;width:56px;height:56px;border-radius:50%;
         background:var(--danger);display:flex;align-items:center;justify-content:center;color:#fff;border:0;cursor:pointer;
         box-shadow:0 8px 18px rgba(0,0,0,.25)}
    .fab svg{width:28px;height:28px}

    /* 목록 공통 */
    .list{background:#fff;border-top:1px solid var(--line);overflow:auto}
    .item{padding:12px;border-bottom:1px solid var(--line);cursor:pointer}
    .item:hover{background:#fafafa}
    .title{font-weight:600}
    .addr{font-size:12px;color:#666}
    .pagination{display:flex;justify-content:center;gap:6px;padding:8px}
    .pagination button{border:1px solid var(--line);background:#fff;padding:4px 8px;border-radius:4px;cursor:pointer}
    .pagination button.active{background:#333;color:#fff}

    /* 모바일: 바텀시트(스와이프) */
    @media (max-width: 767px){
      .list{
        position:fixed;left:0;right:0;bottom:0;z-index:9998;max-height:80vh;height:50vh;border-radius:16px 16px 0 0;
        box-shadow:0 -12px 20px rgba(0,0,0,.12);transform:translateY(70%);transition:transform .25s ease;
        touch-action:none;will-change:transform;user-select:none;
      }
      .list.open{transform:translateY(0)}
      .handle{width:44px;height:5px;border-radius:999px;background:#d1d5db;margin:10px auto 6px;cursor:grab}
      .pagination{display:none}
    }
    /* 데스크톱: 고정 목록 */
    @media (min-width: 768px){
      .list{position:static;transform:none!important;height:clamp(220px, 32vh, 560px);max-height:none}
      .handle{display:none}
    }

    /* ====== 상세 모달 ====== */
    .modal{position:fixed;inset:0;z-index:12000;display:none}
    .modal.open{display:block}
    .modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .modal .sheet{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(640px, 92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:18px;
      box-shadow:0 24px 60px rgba(0,0,0,.25)
    }
    .m-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);gap:8px}
    .m-head-right{display:flex;gap:8px;align-items:center}
    .points{font-weight:800;font-size:18px;background:#ffe8ec;color:#b91c1c;border-radius:999px;padding:6px 12px;display:inline-flex;align-items:center;gap:6px}
    .points.disabled{background:#f3f4f6;color:#9ca3af;filter:grayscale(1)}
    .title-row{display:flex;align-items:center;gap:8px;font-weight:800}
    .pill-done{font-size:12px;color:#065f46;background:#d1fae5;border:1px solid #a7f3d0;border-radius:999px;padding:3px 8px}
    .close{border:0;background:#f3f4f6;border-radius:10px;width:36px;height:36px;cursor:pointer}
    .solve-btn{border:1px solid #111;background:#111;color:#fff;border-radius:10px;height:36px;padding:0 12px;cursor:pointer;font-weight:700}
    .m-body{padding:10px 16px 18px}
    .section{margin-top:10px}
    .label{font-weight:700;margin:10px 0 6px}
    .photo{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:#f8fafc}
    .comment{color:#374151;margin-top:6px;line-height:1.5}
    .meta{color:var(--muted);font-size:12px;margin-top:4px}

    /* ====== 액션 모달(신고/해결 전용 모드) ====== */
    .action-modal{position:fixed;inset:0;z-index:13000;display:none}
    .action-modal.open{display:block}
    .action-modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .action-modal .sheet{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(560px, 92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:18px;
      box-shadow:0 24px 60px rgba(0,0,0,.25)
    }
    .a-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .a-title{font-weight:800}
    .a-body{padding:12px 14px 16px}
    .field{display:grid;gap:6px;margin:12px 0}
    .field label{font-weight:700}
    .uploader{display:grid;gap:10px}
    .preview{width:100%;aspect-ratio:16/9;border:1px dashed #cbd5e1;border-radius:12px;display:grid;place-items:center;overflow:hidden;background:#f8fafc}
    .preview img{width:100%;height:100%;object-fit:cover}
    .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
  </style>
</head>
<body>
  <header>쓰레기 해결</header>

  <div class="container">
    <div class="map-wrap"><div id="map"></div></div>

    <!-- 목록 -->
    <div class="list" id="listPanel" aria-label="신고/해결 목록">
      <div class="handle" aria-hidden="true"></div>
      <div id="listContent"></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <!-- 우상단 사이렌 버튼 (신고 전용) -->
  <button class="fab" id="fab" aria-label="신고하기">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 11V9a5 5 0 0 1 10 0v2" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
      <rect x="4" y="11" width="16" height="7" rx="2" fill="rgba(255,255,255,.15)" stroke="#fff" stroke-width="1.6"/>
      <path d="M12 3v2M5.5 5.5l1.5 1.5M18.5 5.5 17 7" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <!-- ====== 상세 모달 (핀/목록 클릭) ====== -->
  <div class="modal" id="detailModal" aria-modal="true" role="dialog">
    <div class="overlay" id="modalOverlay"></div>
    <div class="sheet" role="document">
      <div class="m-head">
        <div class="points" id="mPoints">200p</div>
        <div class="m-head-right">
          <button class="solve-btn" id="solveBtn">해결하기</button>
          <button class="close" id="modalClose" aria-label="닫기">✕</button>
        </div>
      </div>
      <div class="m-body">
        <div class="title-row">
          <div id="mReporter">@@님의 신고</div>
          <div class="pill-done" id="mDone" style="display:none">해결완료</div>
        </div>
        <div class="meta" id="mAddr"></div>

        <div class="section">
          <div class="label">신고 사진</div>
          <img id="mReportImg" class="photo" alt="신고 사진">
          <div class="comment" id="mReportComment"></div>
        </div>

        <div class="section" id="resolveSection" style="display:none">
          <div class="label"><span id="mResolver">##님의 해결</span></div>
          <img id="mResolveImg" class="photo" alt="해결 사진">
          <div class="comment" id="mResolveComment"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== 액션 모달 (모드별 단일 폼: 신고 OR 해결) ====== -->
  <div class="action-modal" id="actionModal" aria-modal="true" role="dialog">
    <div class="overlay" id="actionOverlay"></div>
    <div class="sheet" role="document">
      <div class="a-head">
        <strong class="a-title" id="actionTitle">신고하기</strong>
        <button class="close" id="actionClose" aria-label="닫기">✕</button>
      </div>

      <!-- 신고 폼 -->
      <div class="a-body" id="reportForm">
        <div class="field">
          <label for="reportFile">신고 사진</label>
          <div class="uploader">
            <div class="preview" id="reportPreview"><span>이미지 미리보기</span></div>
            <input id="reportFile" type="file" accept="image/*" capture="environment">
          </div>
        </div>
        <div class="field">
          <label for="description">설명</label>
          <textarea id="description" rows="4" placeholder="예) 성원초 앞 종량제 봉투가 찢어져 있다." style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;"></textarea>
        </div>
        <div class="actions">
          <button class="btn" id="reportCancel">취소</button>
          <button class="btn primary" onclick="reportCreate();">신고하기</button>
        </div>
      </div>

      <!-- 해결 폼 -->
      <div class="a-body" id="resolveForm" style="display:none">
        <div class="field">
          <label for="resolveFile">해결 사진</label>
          <div class="uploader">
            <div class="preview" id="resolvePreview"><span>이미지 미리보기</span></div>
            <input id="resolveFile" type="file" accept="image/*" capture="environment">
          </div>
        </div>
        <div class="field">
          <label for="resolveDesc">해결 내용</label>
          <textarea id="resolveDesc" rows="4" placeholder="예) 종량제 봉투 구입 후 재포장." style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;"></textarea>
        </div>
        <div class="actions">
          <button class="btn" id="resolveCancel">취소</button>
          <button class="btn primary" id="resolveSubmit">해결하기</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>
  <script>
    /************ 데이터(춘천 5곳) ************/
    const data = [
      { id:1, title:"쓰레기 신고", addr:"춘천시 중앙로 67 (명동 일대)", lat:37.8813, lng:127.7300,
        reporter:"김민수", points:200, reportImg:"https://picsum.photos/seed/report1/960/540",
        reportComment:"성원초 앞에 종량제 봉투가 터져있음", resolved:false},
      { id:2, title:"방치된 쓰레기", addr:"춘천시 석사동 강원대학교 정문", lat:37.874, lng:127.744,
        reporter:"박지영", points:150, reportImg:"https://picsum.photos/seed/report2/960/540",
        reportComment:"정문 앞 화단에 페트병과 일회용컵 다수", resolved:true, resolver:"이도현",
        resolveImg:"https://picsum.photos/seed/resolve2/960/540", resolveComment:"분리수거 후 남은 잔여물 수거 완료" },
      { id:3, title:"불법투기 의심", addr:"춘천시 후평동 후평시장", lat:37.892, lng:127.744,
        reporter:"장하늘", points:120, reportImg:"https://picsum.photos/seed/report3/960/540",
        reportComment:"폐지더미에 일반쓰레기 섞여 있음", resolved:false },
      { id:4, title:"생활폐기물 신고", addr:"춘천시 퇴계동 홈플러스 근처", lat:37.862, lng:127.723,
        reporter:"윤서연", points:300, reportImg:"https://picsum.photos/seed/report4/960/540",
        reportComment:"가로변에 대형폐기물(의자) 방치", resolved:true, resolver:"최재훈",
        resolveImg:"https://picsum.photos/seed/resolve4/960/540", resolveComment:"대형폐기물 스티커 구매 후 배출" },
      { id:5, title:"방치된 폐가구", addr:"춘천시 온의동 의암호 공원", lat:37.889, lng:127.716,
        reporter:"오수진", points:180, reportImg:"https://picsum.photos/seed/report5/960/540",
        reportComment:"산책로 옆에 서랍장 방치", resolved:false }
    ];

    /************ 목록: 웹/앱 대응 ************/
    let currentPage = 1;
    let itemsPerPage = 2;
    const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

    function measureItemHeight(){
      const listContent = document.getElementById('listContent');
      const probe = document.createElement('div');
      probe.className='item'; probe.style.visibility='hidden';
      probe.innerHTML=`<div class="title">측정</div><div class="addr">가나다</div>`;
      listContent.appendChild(probe);
      const h = probe.offsetHeight || 64;
      listContent.removeChild(probe);
      return h;
    }
    function computeItemsPerPage(){
      if (isMobile()) return data.length;
      const panel = document.getElementById('listPanel');
      const pagination = document.getElementById('pagination');
      const available = panel.clientHeight - (pagination.offsetHeight||0) - 12;
      const itemH = measureItemHeight();
      return Math.max(1, Math.floor(available / itemH));
    }
    function addListItem(it){
      const div=document.createElement('div');
      div.className='item';
      div.innerHTML=`<div class="title">${it.title}</div><div class="addr">${it.addr}</div>`;
      div.onclick=()=>openDetailModal(it);
      document.getElementById('listContent').appendChild(div);
    }
    function renderListWeb(page=1){
      itemsPerPage = computeItemsPerPage();
      const listContent = document.getElementById('listContent');
      const pagination  = document.getElementById('pagination');
      listContent.innerHTML=""; pagination.innerHTML="";
      const totalPages = Math.max(1, Math.ceil(data.length/itemsPerPage));
      if (page>totalPages) page = totalPages; currentPage = page;
      const start = (currentPage-1)*itemsPerPage;
      const slice = data.slice(start, start+itemsPerPage);
      slice.forEach(addListItem);
      for(let i=1;i<=totalPages;i++){
        const btn=document.createElement('button');
        btn.textContent=i; if(i===currentPage) btn.classList.add('active');
        btn.onclick=()=>renderListWeb(i);
        pagination.appendChild(btn);
      }
    }
    function renderListMobile(){
      const listContent = document.getElementById('listContent');
      const pagination  = document.getElementById('pagination');
      listContent.innerHTML=""; pagination.innerHTML="";
      data.forEach(addListItem);
    }
    function renderListResponsive(){ if (isMobile()) renderListMobile(); else renderListWeb(currentPage); }

    /************ 상세 모달(핀/목록 클릭) ************/
    const detail = {
      el: document.getElementById('detailModal'),
      points: document.getElementById('mPoints'),
      reporter: document.getElementById('mReporter'),
      done: document.getElementById('mDone'),
      addr: document.getElementById('mAddr'),
      reportImg: document.getElementById('mReportImg'),
      reportComment: document.getElementById('mReportComment'),
      resolveSection: document.getElementById('resolveSection'),
      resolver: document.getElementById('mResolver'),
      resolveImg: document.getElementById('mResolveImg'),
      resolveComment: document.getElementById('mResolveComment'),
      overlay: document.getElementById('modalOverlay'),
      closeBtn: document.getElementById('modalClose'),
      solveBtn: document.getElementById('solveBtn'),
      currentItem: null
    };
    function openDetailModal(item){
      detail.currentItem = item;
      detail.points.textContent = item.points + 'p';
      detail.points.classList.toggle('disabled', !!item.resolved);
      detail.reporter.textContent = item.reporter + '님의 신고';
      detail.done.style.display = item.resolved ? 'inline-flex' : 'none';
      detail.addr.textContent = item.addr;
      detail.reportImg.src = item.reportImg;
      detail.reportImg.alt = item.reporter + ' 신고 사진';
      detail.reportComment.textContent = item.reportComment || '';
      if (item.resolved){
        detail.resolveSection.style.display = '';
        detail.resolver.textContent = (item.resolver || '누군가') + '님의 해결';
        detail.resolveImg.src = item.resolveImg || 'https://picsum.photos/seed/resolve_default/960/540';
        detail.resolveImg.alt = (item.resolver || '누군가') + ' 해결 사진';
        detail.resolveComment.textContent = item.resolveComment || '';
      } else {
        detail.resolveSection.style.display = 'none';
      }
      detail.el.classList.add('open');
      document.documentElement.style.overflow='hidden';
    }
    function closeDetailModal(){ detail.el.classList.remove('open'); document.documentElement.style.overflow=''; }
    detail.overlay.onclick = closeDetailModal;
    detail.closeBtn.onclick = closeDetailModal;

    // 상세 모달 우상단 "해결하기" → 해결 모드로 액션 모달 열기
    detail.solveBtn.onclick = function(){
      openActionModal('resolve', detail.currentItem);
    };
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDetailModal(); });

    /************ 액션 모달 (신고/해결 단일 모드) ************/
    const action = {
      el: document.getElementById('actionModal'),
      overlay: document.getElementById('actionOverlay'),
      closeBtn: document.getElementById('actionClose'),
      title: document.getElementById('actionTitle'),
      // 신고
      reportForm: document.getElementById('reportForm'),
      reportFile: document.getElementById('reportFile'),
      reportPreview: document.getElementById('reportPreview'),
      reportDesc: document.getElementById('reportDesc'),
      reportSubmit: document.getElementById('reportSubmit'),
      reportCancel: document.getElementById('reportCancel'),
      // 해결
      resolveForm: document.getElementById('resolveForm'),
      resolveFile: document.getElementById('resolveFile'),
      resolvePreview: document.getElementById('resolvePreview'),
      resolveDesc: document.getElementById('resolveDesc'),
      resolveSubmit: document.getElementById('resolveSubmit'),
      resolveCancel: document.getElementById('resolveCancel'),
        resolveIdInput: document.getElementById('resolveTargetId'),
      rewardPoints: 200,
      mode: 'report',
      targetItem: null
    };

    function openActionModal(mode='report', item=null){
        action.mode = mode;
        action.targetItem = item;

        if(mode==='report'){
            action.title.textContent = '신고하기';
            action.reportForm.style.display = '';
            action.resolveForm.style.display = 'none';
            // ★ report 모드로 열릴 땐 id 초기화
            if (action.resolveIdInput) action.resolveIdInput.value = '';
            // if (action.resolveIdText) action.resolveIdText.textContent = '';
        } else {
            action.title.textContent = '해결하기';
            action.reportForm.style.display = 'none';
            action.resolveForm.style.display = '';

            // ★ 클릭한 게시글의 id 주입 + 콘솔 출력
            const id = item?.id ?? item?.er_id ?? item?.reportId ?? '';
            if (action.resolveIdInput) action.resolveIdInput.value = id;
            console.log('[resolve-open] report_id:', id, 'item:', item);
            // if (action.resolveIdText) action.resolveIdText.textContent = id;
        }

        action.el.classList.add('open');
        document.documentElement.style.overflow='hidden';
    }
    function closeActionModal(){ action.el.classList.remove('open'); document.documentElement.style.overflow=''; }
    action.overlay.onclick = closeActionModal;
    action.closeBtn.onclick = closeActionModal;

    // FAB → 신고 모달
    document.getElementById('fab').onclick = function(){ openActionModal('report'); };

    // 이미지 미리보기
    function bindPreview(inputEl, previewEl){
      inputEl.addEventListener('change', ()=>{
        const f = inputEl.files && inputEl.files[0];
        if(!f){ previewEl.innerHTML = '<span>이미지 미리보기</span>'; return; }
        const url = URL.createObjectURL(f);
        previewEl.innerHTML = `<img src="${url}" alt="preview">`;
      });
    }


    bindPreview(action.reportFile, action.reportPreview);
    bindPreview(action.resolveFile, action.resolvePreview);

    // 제출
    action.reportCancel.onclick = closeActionModal;


    action.resolveSubmit.onclick = async () => {
        const file = action.resolveFile?.files?.[0];
        const desc = (action.resolveDesc?.value || '').trim();
        const reportId = action.resolveIdInput?.value || (action.targetItem?.id ?? '');

        console.log('[resolve-submit] report_id:', reportId); // ← 확인용 로그

        if (!reportId) { alert('대상 신고 ID가 없습니다.'); return; }
        if (!file)     { alert('해결 사진을 선택해주세요.'); return; }

        // 서버로 보낼 경우 예시(FormData)
        /*
        const fd = new FormData();
        fd.append('report_id', reportId);
        fd.append('description', desc);
        fd.append('image_url', file);

        const headers = {};
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
        if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

        try {
          const res = await fetch('/trash/resolveCreate', { method:'POST', body:fd, headers });
          if (!res.ok) throw new Error('서버 오류: ' + res.status);
          alert('해결이 등록되었습니다.');
          closeActionModal();
        } catch (e) {
          console.error(e);
          alert('업로드 실패: ' + (e?.message || '알 수 없는 오류'));
        }
        */

        // 데모용
        alert(action.rewardPoints + 'p를 받으셨습니다.');
        closeActionModal();
    };
    action.resolveCancel.onclick = closeActionModal;

    /************ 바텀시트 스와이프(앱에서만) ************/
    let detachSwipe;
    function enableSwipeIfMobile(){
      const listPanel = document.getElementById('listPanel');
      const handle    = listPanel.querySelector('.handle');
      if (detachSwipe){ detachSwipe(); detachSwipe=null; }
      if (!isMobile()){ listPanel.style.transform=''; listPanel.classList.remove('open'); return; }
      let basePercent = 70;
      setTranslate(basePercent);
      let dragging=false, startY=0;
      function setTranslate(p){ listPanel.style.transform=`translateY(${p}%)`; }
      function curPercent(){ const m=/translateY\(([-\d.]+)%\)/.exec(listPanel.style.transform); return m?parseFloat(m[1]):basePercent; }
      function down(e){ dragging=true; startY=e.clientY ?? (e.touches && e.touches[0].clientY) ?? 0; listPanel.style.transition='none'; e.target.setPointerCapture?.(e.pointerId); }
      function move(e){ if(!dragging) return; const y=e.clientY ?? (e.touches && e.touches[0].clientY) ?? 0; const dy=y-startY; const dp=(dy/window.innerHeight)*100; let next=Math.max(0, Math.min(70, basePercent+dp)); setTranslate(next); e.preventDefault?.(); }
      function up(){ if(!dragging) return; dragging=false; listPanel.style.transition='transform .25s ease'; const c=curPercent(); if(c>40){ basePercent=70; listPanel.classList.remove('open'); } else { basePercent=0; listPanel.classList.add('open'); } setTranslate(basePercent); }
      const target = handle || listPanel;
      target.style.touchAction='none';
      target.addEventListener('pointerdown',down,{passive:false});
      window.addEventListener('pointermove',move,{passive:false});
      window.addEventListener('pointerup',up,{passive:true});
      window.addEventListener('pointercancel',up,{passive:true});
      detachSwipe=()=>{ target.removeEventListener('pointerdown',down); window.removeEventListener('pointermove',move); window.removeEventListener('pointerup',up); window.removeEventListener('pointercancel',up); listPanel.style.transition=''; };
    }

    /************ 지도 마커 바인딩 ************/
    function bindMap(map){
      data.forEach((it)=>{
        const marker = new kakao.maps.Marker({ position:new kakao.maps.LatLng(it.lat, it.lng), map, title: it.title });
        kakao.maps.event.addListener(marker, 'click', () => openDetailModal(it));
      });
    }
  </script>

  <!-- EXIF 파서 (full) -->
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/exifr.umd.js" defer></script>

  <!-- 필요하면 CSRF 메타가 이미 페이지에 있어야 합니다 -->
  <!-- <meta name="_csrf_header" content="X-CSRF-TOKEN">
  <meta name="_csrf"        content="..."> -->
  <script>
      let LAT = null;
      let LON = null;
      let LAST_TS = null;   // (선택) 타임스탬프

      function success({ coords, timestamp }) {
          LAT = coords.latitude;
          LON = coords.longitude;
          LAST_TS = timestamp;
          console.log('업데이트:', LAT, LON, 'ts=', LAST_TS);
      }

      function error(err) {
          console.warn('geo fail', err);
      }

      function getUserLocation() {
          if (!navigator.geolocation) {
              alert('위치 정보가 지원되지 않습니다.');
              return;
          }
          // 연속 업데이트: 필요 없으면 clearWatch로 중지
          window._watchId = navigator.geolocation.watchPosition(
              success,
              error,
              { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
      }

      function stopWatch() {
          if (window._watchId != null) {
              navigator.geolocation.clearWatch(window._watchId);
              window._watchId = null;
          }
      }

      getUserLocation();

      function getGeoOnce(opts = { enableHighAccuracy:true, timeout:15000, maximumAge:0 }) {
          return new Promise((resolve, reject) =>
              navigator.geolocation.getCurrentPosition(resolve, reject, opts)
          );
      }

      async function reportCreate() {
          const descriptionEl = document.getElementById('description');
          const fileInput     = document.getElementById('reportFile'); // id 일치
          const file          = fileInput?.files?.[0];
          if (!file) { alert('이미지를 선택해주세요.'); return; }
          const description = (descriptionEl?.value || '').trim();
          const title = document.getElementById("title");


          const fd = new FormData();
          fd.append('description', description);
          fd.append('image_url', file);
          fd.append('latitude',  LAT);
          fd.append('longitude', LON);
          fd.append('title', title);

          const headers = {};
          const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
          const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
          if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

          console.log('description :', description);
          console.log('file       :', file);
          console.log('lat        :', LAT);
          console.log('lon        :', LON);

          const res = await fetch('/trash/reportCreate', { method:'POST', body:fd, headers });
          if (!res.ok) throw new Error(`서버 오류: ${res.status}`);
          alert('신고가 등록되었습니다.');
      }
      window.reportCreate = reportCreate; // onclick으로 호출한다면 유지
  </script>





</body>
</html>
